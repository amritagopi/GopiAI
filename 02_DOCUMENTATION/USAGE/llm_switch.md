# Переключение между провайдерами LLM в GopiAI

## Обзор

GopiAI поддерживает переключение между различными провайдерами LLM, включая Google Gemini и OpenRouter. Эта функция позволяет использовать различные модели в зависимости от задачи и доступности.

## Поддерживаемые провайдеры

1. **Google Gemini** - дефолтный провайдер
2. **OpenRouter** - агрегатор различных моделей

## Конфигурация

### Переменные окружения

Для работы с различными провайдерами необходимо установить соответствующие API ключи в файле `.env`:

```env
# Google Gemini API ключ
GEMINI_API_KEY=your_gemini_api_key_here

# OpenRouter API ключ
OPENROUTER_API_KEY=your_openrouter_api_key_here
```

### Файл состояния

Состояние текущего провайдера и модели сохраняется в файле `~/.gopiai_state.json`:

```json
{
  "provider": "gemini",
  "model_id": "gemini/gemini-1.5-flash"
}
```

## Программное переключение

### Через CLI

```bash
# Переключение на OpenRouter
gopiai config set LLM_PROVIDER openrouter

# Переключение на Gemini
gopiai config set LLM_PROVIDER gemini
```

### Через код

```python
from gopiai.core.llm_client import LlmClient

# Получение экземпляра клиента
client = LlmClient.instance()

# Переключение провайдера
import asyncio
asyncio.run(client.swap_provider("openrouter"))

# Генерация текста
response = asyncio.run(client.generate("Привет, как дела?"))
```

### Через UI клиент

```python
from gopiai.ui.llm import get_llm_client

# Получение экземпляра UI клиента
client = get_llm_client()

# Переключение провайдера
import asyncio
asyncio.run(client.swap_provider("gemini"))
```

## Архитектура

### Клиент LLM

Основной клиент LLM реализован как singleton с поддержкой переключения провайдеров:

- `GopiAI-Core/gopiai/core/llm_client.py` - основной клиент
- `GopiAI-Core/gopiai/core/adapters/` - адаптеры для различных провайдеров

### Адаптеры

Каждый провайдер имеет свой адаптер, реализующий общий интерфейс `BaseAdapter`:

- `base_adapter.py` - базовый интерфейс
- `gemini_adapter.py` - адаптер для Google Gemini
- `openrouter_adapter.py` - адаптер для OpenRouter

## Устранение неполадок

### Проблемы с переключением

1. **Проверьте API ключи** - убедитесь, что все необходимые ключи установлены в `.env`
2. **Проверьте файл состояния** - убедитесь, что `~/.gopiai_state.json` доступен для записи
3. **Перезапустите приложение** - после изменения конфигурации перезапустите приложение

### Ошибки таймаута

1. **Увеличьте таймаут** - установите большие значения таймаута для медленных моделей
2. **Проверьте подключение** - убедитесь, что есть доступ к API провайдера
3. **Переключитесь на другой провайдер** - используйте более быструю модель

## Тестирование

### Запуск тестов

```bash
# Тесты для основного клиента LLM
python -m pytest GopiAI-Core/tests/test_llm_client.py

# Тесты для адаптеров
python -m pytest GopiAI-Core/tests/test_adapters.py

# Тесты для UI клиента
python -m pytest GopiAI-UI/tests/test_ui_llm_client.py
```

### Матрица тестирования

| Тест | Описание | Статус |
|------|----------|--------|
| Инициализация клиента | Проверка создания singleton экземпляра | ✅ |
| Переключение провайдеров | Проверка смены провайдера | ✅ |
| Генерация текста | Проверка работы с различными моделями | ✅ |
| Обработка ошибок | Проверка корректной обработки ошибок | ✅ |
| Таймауты | Проверка обработки таймаутов | ✅ |

## Лучшие практики

1. **Всегда проверяйте доступность** - перед переключением провайдера проверяйте наличие API ключа
2. **Используйте таймауты** - устанавливайте разумные значения таймаутов для запросов
3. **Обрабатывайте ошибки** - всегда обрабатывайте возможные ошибки при работе с API
4. **Сохраняйте состояние** - используйте встроенные механизмы сохранения состояния
5. **Тестируйте переключения** - регулярно тестируйте переключение между провайдерами

## Расширение

### Добавление нового провайдера

1. Создайте новый адаптер, наследуясь от `BaseAdapter`
2. Реализуйте все абстрактные методы
3. Добавьте провайдер в конфигурацию
4. Обновите логику переключения в клиенте
5. Добавьте тесты

### Пример нового адаптера

```python
from .base_adapter import BaseAdapter

class NewProviderAdapter(BaseAdapter):
    def __init__(self):
        self.provider_name = "newprovider"
        # Инициализация
    
    async def generate(self, prompt: str, **kwargs) -> str:
        # Реализация генерации
        pass
    
    def is_available(self) -> bool:
        # Проверка доступности
        pass
    
    def get_provider_name(self) -> str:
        return self.provider_name
