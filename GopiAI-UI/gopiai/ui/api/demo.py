#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã API –∫–ª–∏–µ–Ω—Ç–∞ GopiAI.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ API –∫–ª–∏–µ–Ω—Ç–∞
–∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±—ç–∫–µ–Ω–¥–æ–º.
"""

import sys
import time
from gopiai.ui.api import GopiAIAPIClient, get_default_client


def demo_basic_usage():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –∫–ª–∏–µ–Ω—Ç–∞."""
    print("üöÄ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è API –∫–ª–∏–µ–Ω—Ç–∞ GopiAI")
    print("=" * 50)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
    print("\n1. –°–æ–∑–¥–∞–Ω–∏–µ API –∫–ª–∏–µ–Ω—Ç–∞...")
    client = GopiAIAPIClient(base_url="http://localhost:5051", timeout=10)
    print(f"   ‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: {client.base_url}")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
        print("\n2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞...")
        is_healthy = client.health_check()
        if is_healthy:
            print("   ‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∑–¥–æ—Ä–æ–≤")
        else:
            print("   ‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ–∑–¥–æ—Ä–æ–≤")
            print("   üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5051")
            return
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
        print("\n3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π...")
        models = client.get_available_models()
        if models:
            print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(models)} –º–æ–¥–µ–ª–µ–π:")
            for i, model in enumerate(models[:3], 1):  # –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ 3
                print(f"      {i}. {model.get('id', 'unknown')} - {model.get('name', 'unknown')}")
            if len(models) > 3:
                print(f"      ... –∏ –µ—â–µ {len(models) - 3} –º–æ–¥–µ–ª–µ–π")
        else:
            print("   ‚ùå –ú–æ–¥–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã")
            return
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        print("\n4. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...")
        test_message = "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç API –∫–ª–∏–µ–Ω—Ç–∞. –ú–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–æ?"
        
        print(f"   üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º: {test_message}")
        start_time = time.time()
        
        result = client.send_message(test_message)
        
        end_time = time.time()
        response_time = end_time - start_time
        
        if result["status"] == "success":
            print(f"   ‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∑–∞ {response_time:.2f}s:")
            print(f"   üí¨ {result['response'][:200]}...")
            
            tools_used = result.get("tools_used", [])
            if tools_used:
                print(f"   üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: {[tool['name'] for tool in tools_used]}")
            
            execution_time = result.get("execution_time")
            if execution_time:
                print(f"   ‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: {execution_time:.2f}s")
                
        else:
            print(f"   ‚ùå –û—à–∏–±–∫–∞: {result.get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}")
            print(f"   üîç –ö–æ–¥ –æ—à–∏–±–∫–∏: {result.get('error_code', 'UNKNOWN')}")
    
    finally:
        # –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
        print("\n5. –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–ª–∏–µ–Ω—Ç–∞...")
        client.close()
        print("   ‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç")


def demo_error_handling():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫."""
    print("\nüõ†Ô∏è  –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫")
    print("=" * 50)
    
    # –¢–µ—Å—Ç —Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º
    print("\n1. –¢–µ—Å—Ç —Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º...")
    client = GopiAIAPIClient(base_url="http://nonexistent-server:9999", timeout=3)
    
    try:
        result = client.send_message("–¢–µ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞")
        print(f"   ‚ùå –û—à–∏–±–∫–∞: {result['message']}")
        print(f"   üîç –ö–æ–¥: {result['error_code']}")
    finally:
        client.close()
    
    # –¢–µ—Å—Ç —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    print("\n2. –¢–µ—Å—Ç —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º...")
    client = GopiAIAPIClient(base_url="http://localhost:5051", timeout=0.001)
    
    try:
        result = client.send_message("–¢–µ—Å—Ç —Ç–∞–π–º–∞—É—Ç–∞")
        print(f"   ‚ùå –û—à–∏–±–∫–∞: {result['message']}")
        print(f"   üîç –ö–æ–¥: {result['error_code']}")
    finally:
        client.close()


def demo_global_client():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞."""
    print("\nüåê –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞")
    print("=" * 50)
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    print("\n1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞...")
    client1 = get_default_client()
    client2 = get_default_client()
    
    print(f"   ‚úÖ –ö–ª–∏–µ–Ω—Ç 1: {id(client1)}")
    print(f"   ‚úÖ –ö–ª–∏–µ–Ω—Ç 2: {id(client2)}")
    print(f"   üîç –≠—Ç–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç: {client1 is client2}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
    if client1.health_check():
        print("   ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç")
    else:
        print("   ‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç")


def demo_context_manager():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞."""
    print("\nüì¶ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞")
    print("=" * 50)
    
    print("\n1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ with statement...")
    
    with GopiAIAPIClient() as client:
        print(f"   ‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ: {client.base_url}")
        
        if client.health_check():
            print("   ‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω")
            
            result = client.send_message("–ö–æ—Ä–æ—Ç–∫–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            if result["status"] == "success":
                print("   ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ")
            else:
                print(f"   ‚ùå –û—à–∏–±–∫–∞: {result['message']}")
        else:
            print("   ‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    
    print("   ‚úÖ –ö–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏."""
    print("üéØ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è API –∫–ª–∏–µ–Ω—Ç–∞ GopiAI")
    print("–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ API –∫–ª–∏–µ–Ω—Ç–∞")
    print()
    
    try:
        # –û—Å–Ω–æ–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
        demo_basic_usage()
        
        # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        demo_error_handling()
        
        # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        demo_global_client()
        
        # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        demo_context_manager()
        
        print("\nüéâ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        print("\nüí° –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:")
        print("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ health_check() –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π")
        print("   ‚Ä¢ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É result['status']")
        print("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è")
        print("   ‚Ä¢ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —É–¥–æ–±–µ–Ω –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤")
        
    except KeyboardInterrupt:
        print("\n\n‚èπÔ∏è  –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)
    except Exception as e:
        print(f"\n\nüí• –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()