#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∞–º–∏
===========================================

–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏ 10: Enhanced tab management with error recovery
"""

import sys
import os
from PySide6.QtWidgets import QApplication, QMainWindow, QVBoxLayout, QWidget, QPushButton, QHBoxLayout
from PySide6.QtCore import Qt

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º GopiAI
sys.path.insert(0, os.path.dirname(__file__))

from gopiai.ui.components.tab_widget_fixed import TabDocumentWidgetFixed


class TabManagementDemo(QMainWindow):
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∞–º–∏"""

    def __init__(self):
        super().__init__()
        self.setWindowTitle("GopiAI - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∞–º–∏")
        self.setGeometry(100, 100, 1200, 800)
        
        # –°–æ–∑–¥–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –≤–∏–¥–∂–µ—Ç
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        # –û—Å–Ω–æ–≤–Ω–æ–π layout
        layout = QVBoxLayout(central_widget)
        
        # –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        button_layout = QHBoxLayout()
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        create_text_btn = QPushButton("üìÑ –°–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É")
        create_text_btn.clicked.connect(self.create_text_tab)
        button_layout.addWidget(create_text_btn)
        
        create_multiple_btn = QPushButton("üìö –°–æ–∑–¥–∞—Ç—å 5 –≤–∫–ª–∞–¥–æ–∫")
        create_multiple_btn.clicked.connect(self.create_multiple_tabs)
        button_layout.addWidget(create_multiple_btn)
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è
        close_all_btn = QPushButton("üóô –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ")
        close_all_btn.clicked.connect(self.close_all_tabs)
        button_layout.addWidget(close_all_btn)
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
        test_error_btn = QPushButton("‚ö†Ô∏è –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫")
        test_error_btn.clicked.connect(self.test_error_handling)
        button_layout.addWidget(test_error_btn)
        
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–µ—Ç—Ä–∏–∫
        metrics_btn = QPushButton("üìä –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏")
        metrics_btn.clicked.connect(self.show_metrics)
        button_layout.addWidget(metrics_btn)
        
        layout.addLayout(button_layout)
        
        # –°–æ–∑–¥–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∞–º–∏
        self.tab_widget = TabDocumentWidgetFixed()
        layout.addWidget(self.tab_widget)
        
        # –°—á–µ—Ç—á–∏–∫ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω
        self.tab_counter = 0
        
        print("üöÄ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∞–º–∏ –∑–∞–ø—É—â–µ–Ω–∞!")
        print("üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:")
        print("   ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –≤–∫–ª–∞–¥–æ–∫ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫")
        print("   ‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ü–ö–ú –Ω–∞ –≤–∫–ª–∞–¥–∫–µ) —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –∑–∞–∫—Ä—ã—Ç–∏—è")
        print("   ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≤–∫–ª–∞–¥–æ–∫")
        print("   ‚Ä¢ Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–æ–∑–¥–∞–Ω–∏—è")
        print("   ‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤")

    def create_text_tab(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–µ–∫—Å—Ç–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–∏"""
        self.tab_counter += 1
        title = f"–î–æ–∫—É–º–µ–Ω—Ç {self.tab_counter}"
        content = f"–≠—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ {self.tab_counter}.\n\n–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –©–µ–ª–∫–Ω—É—Ç—å –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é\n‚Ä¢ –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–æ–∫ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è\n‚Ä¢ –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
        
        editor = self.tab_widget.add_new_tab(title, content)
        if editor:
            print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ –≤–∫–ª–∞–¥–∫–∞: {title}")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏: {title}")

    def create_multiple_tabs(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∫–ª–∞–¥–æ–∫ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏"""
        for i in range(5):
            self.tab_counter += 1
            title = f"–¢–µ—Å—Ç {self.tab_counter}"
            content = f"–¢–µ—Å—Ç–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ #{self.tab_counter}\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ü–ö–ú) –¥–ª—è:\n‚Ä¢ –ó–∞–∫—Ä—ã—Ç–∏—è —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏\n‚Ä¢ –ó–∞–∫—Ä—ã—Ç–∏—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫\n‚Ä¢ –ó–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫\n‚Ä¢ –ó–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–æ–∫ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞"
            
            self.tab_widget.add_new_tab(title, content)
        
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–∫–ª–∞–¥–æ–∫ (–≤—Å–µ–≥–æ: {self.tab_widget.tab_widget.count()})")

    def close_all_tabs(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫"""
        count_before = self.tab_widget.tab_widget.count()
        self.tab_widget.tab_widget._safe_close_all()
        count_after = self.tab_widget.tab_widget.count()
        
        print(f"üóô –ó–∞–∫—Ä—ã—Ç–æ {count_before - count_after} –≤–∫–ª–∞–¥–æ–∫")
        if count_after == 0:
            print("üñºÔ∏è –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")

    def test_error_handling(self):
        """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"""
        print("‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫...")
        
        # –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–æ–π
        try:
            # –°–∏–º—É–ª–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ—à–∏–±–∫–∏
            editor = self.tab_widget.add_new_tab("üîß –¢–µ—Å—Ç –æ—à–∏–±–æ–∫", "–≠—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤")
            if editor:
                print("‚úÖ Fallback –º–µ—Ö–∞–Ω–∏–∑–º —Å—Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
            else:
                print("‚ùå –û—à–∏–±–∫–∞ –≤ fallback –º–µ—Ö–∞–Ω–∏–∑–º–µ")
        except Exception as e:
            print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        try:
            self.tab_widget._close_tab(-1)  # –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å
            self.tab_widget._close_tab(999)  # –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å
            print("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤: {e}")

    def show_metrics(self):
        """–ü–æ–∫–∞–∑ –º–µ—Ç—Ä–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏"""
        metrics = self.tab_widget.get_stability_metrics()
        
        print("üìä –ú–µ—Ç—Ä–∏–∫–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:")
        print(f"   ‚Ä¢ –í—Å–µ–≥–æ –≤–∫–ª–∞–¥–æ–∫: {metrics['total_tabs']}")
        print(f"   ‚Ä¢ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤: {metrics['registered_widgets']}")
        print(f"   ‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ñ–æ–Ω: {'–î–∞' if metrics['background_displayed'] else '–ù–µ—Ç'}")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        if metrics['total_tabs'] == 0:
            print("   ‚Ä¢ –°–æ—Å—Ç–æ—è–Ω–∏–µ: –í—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
        else:
            print(f"   ‚Ä¢ –°–æ—Å—Ç–æ—è–Ω–∏–µ: –ê–∫—Ç–∏–≤–Ω–æ {metrics['total_tabs']} –≤–∫–ª–∞–¥–æ–∫")

    def closeEvent(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        print("üßπ –í—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤...")
        self.tab_widget.force_cleanup()
        print("‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        event.accept()


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏"""
    app = QApplication(sys.argv)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    app.setStyle('Fusion')
    
    # –°–æ–∑–¥–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–∫–Ω–æ
    demo = TabManagementDemo()
    demo.show()
    
    print("\n" + "="*60)
    print("üéØ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ó–ê–î–ê–ß–ò 10: Enhanced Tab Management")
    print("="*60)
    print("üìù –ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è:")
    print("   1. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫")
    print("   2. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –∑–∞–∫—Ä—ã—Ç–∏—è")
    print("   3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ–Ω–∞")
    print("   4. Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã")
    print("   5. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤")
    print("\nüí° –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:")
    print("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫")
    print("   ‚Ä¢ –©–µ–ª–∫–Ω–∏—Ç–µ –ü–ö–ú –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é")
    print("   ‚Ä¢ –ó–∞–∫—Ä–æ–π—Ç–µ –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ñ–æ–Ω")
    print("   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏")
    print("="*60)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    sys.exit(app.exec())


if __name__ == "__main__":
    main()