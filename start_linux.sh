#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ GopiAI —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–µ—Ä–∞ CrewAI –∏ UI

echo "üöÄ –ó–∞–ø—É—Å–∫ GopiAI (—Å–µ—Ä–≤–µ—Ä CrewAI –∏ UI)..."

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -d ".venv" ]; then
    echo "üì¶ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    source .venv/bin/activate
else
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ."
    exit 1
fi

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:$(pwd):$(pwd)/GopiAI-UI"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
cleanup() {
    echo -e "\nüõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã..."
    echo "üîå –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ CrewAI..."
    # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ü–µ—Å—Å —Å–µ—Ä–≤–µ—Ä–∞ CrewAI –ø–æ –ø–æ—Ä—Ç—É –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –µ–≥–æ
    SERVER_PID=$(lsof -t -i :5052)
    if [ -n "$SERVER_PID" ]; then
        echo "‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ CrewAI —Å–µ—Ä–≤–µ—Ä–∞ (PID: $SERVER_PID)..."
        kill -9 "$SERVER_PID" # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
        sleep 5 # –î–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Ü–µ—Å—Å—É –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
        echo "‚úÖ –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–µ—Ä–≤–µ—Ä CrewAI (PID $SERVER_PID) –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    else
        echo "‚ÑπÔ∏è –°–µ—Ä–≤–µ—Ä CrewAI –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    fi
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap cleanup SIGINT SIGTERM

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ CrewAI (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
echo "üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
SERVER_PID=$(lsof -t -i :5052)
if [ -n "$SERVER_PID" ]; then
    echo "‚ö†Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ CrewAI —Å–µ—Ä–≤–µ—Ä–∞ (PID: $SERVER_PID)..."
    kill -9 "$SERVER_PID"
    sleep 2
    echo "‚úÖ –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–µ—Ä–≤–µ—Ä CrewAI –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
else
    echo "‚ÑπÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–µ—Ä–≤–µ—Ä CrewAI –Ω–µ –Ω–∞–π–¥–µ–Ω."
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä CrewAI –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (—Å –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º venv)
echo "‚öôÔ∏è –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ CrewAI –Ω–∞ –ø–æ—Ä—Ç—É 5052..."
nohup bash -c "cd GopiAI-CrewAI && source venv/bin/activate && python crewai_api_server.py" > GopiAI-CrewAI/server_startup.log 2>&1 &
SERVER_PROCESS_PID=$!
echo "‚úÖ –°–µ—Ä–≤–µ—Ä CrewAI –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (PID: $SERVER_PROCESS_PID). –õ–æ–≥–∏ –≤ GopiAI-CrewAI/server_startup.log"

# –î–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–ø—É—Å–∫
echo "‚è≥ –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥, –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä CrewAI –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è..."
sleep 5

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è UI
#echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è GopiAI UI..."
#/home/amritagopi/GopiAI/.venv/bin/pip install -r GopiAI-UI/requirements_ui.txt

# –ó–∞–ø—É—Å–∫–∞–µ–º UI –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
echo "üé® –ó–∞–ø—É—Å–∫ GopiAI UI..."
.venv/bin/python -m gopiai.ui.main

# –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞ SIGINT (Ctrl+C) –∏–ª–∏ SIGTERM,
# –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–µ—Ä–≤–µ—Ä–∞ CrewAI
# –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ UI –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç–∞, —Å–µ—Ä–≤–µ—Ä CrewAI —Ç–æ–∂–µ –∑–∞–≤–µ—Ä—à–∞–ª—Å—è.
kill $SERVER_PROCESS_PID