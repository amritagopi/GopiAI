#!/bin/bash

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

VENV_DIR=".venv"

echo -e "\n=== –ó–∞–ø—É—Å–∫ GopiAI –¥–ª—è Linux ===\n"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -d "$VENV_DIR" ]; then
    echo "–û—à–∏–±–∫–∞: –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ '$VENV_DIR' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ setup_linux.sh"
    exit 1
fi

# –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –ø–æ—Ä—Ç 5051
echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–µ—Ä–∞ CrewAI (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)..."
pkill -f "python3 GopiAI-CrewAI/crewai_api_server.py" || true
echo "–ü—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∏–ª–∏ –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω)."

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
echo "–ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è: $VENV_DIR"
source "$VENV_DIR/bin/activate"

# –î–æ–±–∞–≤–ª—è–µ–º GopiAI-CrewAI –≤ PYTHONPATH –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
export PYTHONPATH="${PYTHONPATH}:$(pwd)/GopiAI-CrewAI"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo -e "\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    pkill -f "python.*crewai_api_server.py" 2>/dev/null || true
    pkill -f "python.*gopiai.ui.main" 2>/dev/null || true
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap cleanup SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä CrewAI –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ CrewAI..."
cd GopiAI-CrewAI
python crewai_api_server.py > ../crewai_server.log 2>&1 &
CREWAI_PID=$!
cd ..

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ CrewAI..."
for i in {1..30}; do
    curl -s http://127.0.0.1:5051/api/health > /dev/null 2>&1
    CURL_EXIT_CODE=$?
    if [ $CURL_EXIT_CODE -eq 0 ]; then
        echo "‚úÖ –°–µ—Ä–≤–µ—Ä CrewAI –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ (PID: $CREWAI_PID)"
        break
    elif [ $CURL_EXIT_CODE -ne 7 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞ curl –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ (exit code: $CURL_EXIT_CODE)"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞."
        echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
        tail -20 crewai_server.log
        cleanup
        exit 1
    fi
    if [ $i -eq 30 ]; then
        echo "‚ùå –°–µ—Ä–≤–µ—Ä CrewAI –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ 30 —Å–µ–∫—É–Ω–¥"
        echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
        tail -20 crewai_server.log
        cleanup
    fi
    sleep 1
done

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üé® –ó–∞–ø—É—Å–∫ GopiAI UI..."
python -m gopiai.ui.main 2> ui_errors.log || {
    echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ UI. –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ ui_errors.log'
    cat ui_errors.log
    echo '–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...'
    read
    cleanup
}

# –í—ã–∑—ã–≤–∞–µ–º cleanup –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
cleanup

echo -e "\n=== –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ GopiAI –∑–∞–≤–µ—Ä—à–∏–ª–æ —Ä–∞–±–æ—Ç—É ===\n"