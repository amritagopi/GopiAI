# Интеграция с MCP Serena в GopiAI

## Общая информация

Интеграция с MCP Serena позволяет GopiAI получить полноценный доступ к возможностям Serena для работы с кодовой базой, файловой системой, поиска символов в коде и другим функциям, необходимым для эффективного анализа и работы с кодом.

## Архитектура интеграции

Интеграция состоит из следующих компонентов:

1. **SerenaIntegration** - основной класс интеграции, расположенный в файле `app/mcp/serena_integration.py`. Он предоставляет high-level API для работы с инструментами Serena через MCP.

2. **SerenaTools** - класс с базовыми инструментами Serena, расположенный в файле `app/mcp/serena_tools.py`. В основном используется для локальных операций и в качестве резервного варианта, если MCP Serena недоступен.

3. **ReasoningAgent** - агент, использующий интеграцию с Serena через модуль `SerenaIntegration` для выполнения задач анализа кода и работы с файловой системой.

## Основные возможности

Благодаря интеграции с MCP Serena, ReasoningAgent получает следующие возможности:

### Работа с файловой системой:
- Чтение содержимого файлов
- Создание и запись файлов
- Получение списка файлов в директории
- Анализ структуры директорий

### Работа с кодовой базой:
- Получение обзора символов в файле или директории
- Поиск символов по имени (классы, методы, функции и т.д.)
- Поиск символов, ссылающихся на указанный символ
- Анализ контекста символа

### Работа с memories:
- Чтение существующих memory файлов
- Запись новых memory файлов
- Получение списка доступных memories

## Инициализация и проверка доступности

При инициализации ReasoningAgent:
1. Создается экземпляр SerenaIntegration
2. Проверяется наличие всех необходимых инструментов Serena
3. Производится инициализация соединения с Serena
4. Получается список доступных memories
5. В случае успешной инициализации, логируется информация о доступности Serena

## Обработка инструментов Serena

В методе `process_tool_call` класса ReasoningAgent реализована специальная обработка для инструментов, начинающихся с `mcp_serena_`. При вызове такого инструмента, запрос перенаправляется на соответствующий метод класса SerenaIntegration.

## Требования для работы

Для корректной работы интеграции необходим доступ к следующим инструментам MCP Serena:
- mcp_serena_initial_instructions
- mcp_serena_check_onboarding_performed
- mcp_serena_read_file
- mcp_serena_create_text_file
- mcp_serena_list_dir
- mcp_serena_get_symbols_overview
- mcp_serena_find_symbol
- mcp_serena_find_referencing_symbols

## Примеры использования

### Чтение файла через Serena:

```python
# Получаем содержимое файла app/mcp/serena_integration.py
result = await reasoning_agent.process_tool_call(
    "mcp_serena_read_file",
    relative_path="app/mcp/serena_integration.py"
)
```

### Поиск символа (класса или функции) в коде:

```python
# Ищем класс SerenaIntegration
result = await reasoning_agent.process_tool_call(
    "mcp_serena_find_symbol",
    name="SerenaIntegration",
    include_body=True
)
```

### Чтение содержимого memory файла:

```python
# Читаем содержимое memory файла workflow_state.md
result = await reasoning_agent.process_tool_call(
    "mcp_serena_read_memory",
    memory_file_name="workflow_state.md"
)
```

## Возможные проблемы и их решение

1. **Отсутствуют необходимые инструменты MCP Serena**:
   - Проверьте, что MCP сервер запущен с поддержкой Serena
   - Убедитесь, что в конфигурации MCP (`mcp.json`) указан корректный путь к Serena

2. **Не выполнен onboarding Serena**:
   - При первом запуске Serena нужно провести onboarding, создав основные memory файлы
   - Запустите MCP сервер с флагом `--onboarding` или используйте инструмент `mcp_serena_onboarding`

3. **Проблемы с доступом к файловой системе**:
   - Проверьте, что у приложения есть права на чтение/запись в указанных директориях
   - Убедитесь, что пути указаны относительно корневой директории проекта

## Логирование

Все операции, выполняемые через SerenaIntegration, логируются с использованием стандартного механизма логирования. Это позволяет отслеживать взаимодействие с Serena и диагностировать возможные проблемы.
