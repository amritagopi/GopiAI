# Реализация индексирования истории чата

## Общие сведения

Реализована система для индексирования и поиска в истории чатов браузерного агента. Система состоит из следующих компонентов:

1. **ChatHistoryIndexer** - класс для работы с индексами и хранения метаданных
2. **ChatSearchDialog** - диалог для поиска по истории чатов
3. Модификации **BrowserAgentDialog** для интеграции с индексатором

## Особенности реализации

- **Многоформатное хранение**: Каждая сессия чата сохраняется в форматах JSON (полные данные) и TXT (для удобства чтения).
- **SQLite индексирование**: Используется SQLite для индексирования сообщений и метаданных.
- **Полнотекстовый поиск**: Реализован через FTS5 в SQLite.
- **Фильтрация поиска**: Возможность поиска по отправителю, дате, содержимому и т.д.

## Местоположение файлов

- `app/utils/chat_indexer.py` - основной класс для работы с индексами
- `app/ui/chat_search_dialog.py` - диалог для поиска по истории
- `app/ui/browser_agent_dialog.py` - модифицирован для интеграции с индексатором

## Формат хранения данных

Данные хранятся в директории `~/.gopi_ai/chat_history/`:
- JSON-файлы: `browser_agent_{session_id}.json`
- TXT-файлы: `txt/chat_{session_id}.txt`
- База данных SQLite: `chat_index.db`

## Встройка с Llama Index

В модуле `chat_indexer.py` реализована заготовка для интеграции с Llama Index для семантического поиска, 
которая может быть расширена в будущем.

## Применение в UI

- Добавлена кнопка "Search History" в интерфейсе чата
- Создан диалог поиска с фильтрами и предпросмотром
- Автоматическое сохранение сообщений в индекс

## Потенциальные улучшения

1. Реализовать полную интеграцию с Llama Index для семантического поиска
2. Добавить возможность агрегированной статистики по чатам
3. Реализовать контекстный поиск (найти сообщения до и после)
4. Добавить возможность удаления сообщений из истории
5. Реализовать полное восстановление сессии из найденных сообщений