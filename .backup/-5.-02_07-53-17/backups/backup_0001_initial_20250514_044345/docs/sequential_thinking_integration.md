# Интеграция с MCP Sequential Thinking в GopiAI

## Общая информация

Интеграция с MCP Sequential Thinking предоставляет GopiAI возможность последовательного, структурированного мышления для решения сложных задач, анализа проблем и оценки решений. Этот модуль является ключевым компонентом для реализации глубокого рассуждения и принятия решений в рамках архитектуры "План → Разрешение → Выполнение".

## Архитектура интеграции

Интеграция состоит из следующих компонентов:

1. **SequentialThinking** - основной класс интеграции, расположенный в файле `app/mcp/sequential_thinking.py`. Он предоставляет high-level API для работы с инструментами Sequential Thinking через MCP.

2. **ReasoningAgent** - агент, использующий интеграцию с Sequential Thinking для выполнения сложных рассуждений, анализа проблем и генерации структурированных выводов.

## Основные возможности

Благодаря интеграции с MCP Sequential Thinking, ReasoningAgent получает следующие возможности:

### Цепочки рассуждений:
- Создание последовательных шагов мышления
- Ревизия предыдущих мыслей и исправление ошибок рассуждения
- Ветвление логики для рассмотрения альтернатив
- Анализ контекста и структурированный вывод

### Анализ проблем:
- Подробный разбор сложных проблем
- Выявление ключевых моментов и зависимостей
- Формирование структурированных выводов
- Оценка рисков и ограничений

### Оценка решений:
- Анализ предложенных решений по набору критериев
- Выявление сильных и слабых сторон
- Расчет общей оценки решения
- Формирование рекомендаций

### Структурированный вывод:
- Генерация данных в заданном формате
- Структурирование сложной информации
- Трассировка процесса рассуждения
- Документирование логики и решений

## Инициализация и проверка доступности

При инициализации ReasoningAgent:
1. Создается экземпляр SequentialThinking
2. Проверяется наличие необходимых инструментов Sequential Thinking
3. Производится инициализация соединения с Sequential Thinking модулем
4. В случае отсутствия модуля или ошибки инициализации, процесс останавливается
5. В случае успешной инициализации, логируется информация о доступности Sequential Thinking

## Обработка инструментов Sequential Thinking

В методе `process_tool_call` класса ReasoningAgent реализована специальная обработка для инструментов Sequential Thinking:

1. Прямая обработка инструмента `mcp_sequential-thinking_sequentialthinking` для базовых операций
2. Обработка высокоуровневых инструментов через интерфейс SequentialThinking:
   - `analyze_problem` - анализ проблемы
   - `evaluate_solution` - оценка решения
   - `generate_structured_output` - генерация структурированного вывода
   - `branching_analysis` - ветвящийся анализ вариантов

## Примеры использования

### Создание плана через цепочку рассуждений:

```python
# Создаем план для задачи
plan = await reasoning_agent.create_plan("Разработать модуль аутентификации для веб-приложения")
```

### Анализ проблемы:

```python
# Анализируем проблему
analysis = await reasoning_agent.process_tool_call(
    "analyze_problem",
    problem_description="Как оптимизировать производительность базы данных при высоких нагрузках?",
    depth=7
)
```

### Оценка решения:

```python
# Оцениваем предложенное решение
evaluation = await reasoning_agent.process_tool_call(
    "evaluate_solution",
    problem="Низкая производительность базы данных",
    solution="Внедрить кэширование и оптимизировать индексы",
    criteria=["Эффективность", "Сложность внедрения", "Масштабируемость"]
)
```

### Ветвящийся анализ вариантов:

```python
# Сравниваем несколько вариантов решения
comparison = await reasoning_agent.process_tool_call(
    "branching_analysis",
    question="Какой фреймворк выбрать для проекта?",
    options=["React", "Vue", "Angular"],
    depth_per_option=4
)
```

## Требования для работы

Для корректной работы интеграции необходим доступ к инструменту MCP Sequential Thinking:
- mcp_sequential-thinking_sequentialthinking

## Возможные проблемы и их решение

1. **Отсутствует инструмент Sequential Thinking**:
   - Проверьте, что MCP сервер запущен с поддержкой Sequential Thinking
   - Убедитесь, что в конфигурации MCP (`mcp.json`) указан корректный путь к Sequential Thinking модулю

2. **Ошибки в процессе рассуждения**:
   - Проверьте, что исходные данные для рассуждения корректны и полны
   - Увеличьте глубину рассуждения для более сложных задач
   - Используйте ревизию мыслей для исправления ошибок в рассуждении

3. **Проблемы с форматированием вывода**:
   - Используйте метод `generate_structured_output` с четко определенным форматом
   - Проверяйте результаты на соответствие ожидаемому формату
   - Используйте Try-Except блоки для обработки ошибок парсинга

## Логирование

Все операции, выполняемые через SequentialThinking, логируются с использованием стандартного механизма логирования. Это позволяет отслеживать процесс рассуждения и диагностировать возможные проблемы.

## Интеграция с другими модулями

Sequential Thinking тесно интегрирован с другими ключевыми модулями GopiAI:

1. **Serena** - для анализа кодовой базы и работы с файловой системой
2. **PermissionManager** - для контроля доступа к операциям
3. **TerminalAccess** - для выполнения команд в терминале
4. **BrowserAccess** - для взаимодействия с веб-страницами
5. **FileSystemAccess** - для работы с файловой системой

Вместе эти модули образуют мощную экосистему для решения сложных задач с использованием структурированного мышления и безопасного доступа к ресурсам.
