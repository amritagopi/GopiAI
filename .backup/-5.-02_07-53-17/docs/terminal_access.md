# Безопасный доступ к терминалу в GopiAI

Модуль `TerminalAccess` предоставляет безопасный и контролируемый доступ к возможностям терминала операционной системы для ReasoningAgent. Этот модуль разработан с учетом безопасности и включает механизмы проверки команд, управления рабочими директориями и контроля доступа.

## Основные возможности

1. **Проверка безопасности команд**
   - Блокирование потенциально опасных команд
   - Фильтрация команд по регулярным выражениям
   - Предотвращение выхода за пределы рабочей директории

2. **Управление рабочими директориями**
   - Ограничение доступа только к разрешенным директориям
   - Безопасная навигация между директориями
   - Расширяемый список разрешенных директорий

3. **Контроль выполнения команд**
   - Таймауты выполнения
   - Ограничение вывода для предотвращения перегрузки
   - Полный журнал выполнения команд

4. **Расширенные функции**
   - Управление переменными окружения
   - Получение информации о системе
   - Безопасное выполнение Python-скриптов

## Примеры использования

### Выполнение базовых команд

```python
terminal = TerminalAccess(root_dir="/path/to/project")

# Выполнение простой команды
result = await terminal.execute_command("echo Hello World")
if result["success"]:
    print(result["stdout"])
else:
    print(f"Ошибка: {result['stderr']}")

# Получение списка файлов в текущей директории
files = await terminal.execute_command("dir" if sys.platform == "win32" else "ls -la")
print(files["stdout"])
```

### Навигация по директориям

```python
# Проверка текущей директории
current_dir = terminal.get_current_directory()
print(f"Текущая директория: {current_dir}")

# Переход в другую директорию
if terminal.set_current_directory("./app"):
    print("Директория успешно изменена")
else:
    print("Не удалось изменить директорию")

# Выполнение команды в определенной директории
result = await terminal.execute_command("ls -la", working_dir="./tests")
```

### Управление переменными окружения

```python
# Установка переменной окружения
terminal.set_environment_variable("DEBUG", "true")

# Получение всех переменных окружения
env_vars = terminal.get_environment_variables()

# Выполнение команды с дополнительными переменными
result = await terminal.execute_command("python script.py",
                                       env_vars={"PYTHONPATH": "./lib"})
```

### Работа с Python-скриптами

```python
# Безопасное выполнение Python-скрипта
result = await terminal.execute_python_script(
    "scripts/analyze_data.py",
    args=["--input", "data.csv", "--output", "results.json"],
    timeout=60.0
)
```

## Безопасность

Модуль включает несколько уровней безопасности:

1. **Список запрещенных команд** - блокирует команды, известные как потенциально опасные
2. **Регулярные выражения** - проверяет команды на соответствие опасным шаблонам
3. **Ограничение директорий** - предотвращает доступ к несанкционированным путям
4. **Таймауты** - предотвращает зависание или выполнение долгих команд
5. **Контроль расширений файлов** - ограничивает доступ к файлам определенных типов

## Конфигурация

При создании объекта `TerminalAccess` можно настроить его поведение:

```python
terminal = TerminalAccess(
    root_dir="/path/to/project",     # Корневая директория проекта
    max_output_lines=1000,           # Максимальное количество строк вывода
    safe_mode=True,                  # Режим безопасности
    timeout=30.0                     # Тайм-аут по умолчанию (в секундах)
)
```

## Интеграция с ReasoningAgent

Модуль `TerminalAccess` используется в ReasoningAgent для безопасного выполнения команд в процессе reasoning. Агент использует этот модуль для:

1. Выполнения команд, необходимых для анализа кода
2. Запуска тестов и других скриптов
3. Навигации по файловой системе проекта
4. Получения информации о системном окружении

Все команды выполняются только после одобрения плана действий, что обеспечивает дополнительный уровень безопасности.

## Журналирование и мониторинг

Все команды, выполняемые через `TerminalAccess`, логируются с полной информацией:

- Командная строка
- Рабочая директория
- Статус выполнения
- Время начала и продолжительность
- Код возврата
- Вывод stdout и stderr

История команд может быть получена для анализа и отладки:

```python
# Получение полной истории команд
history = terminal.get_command_history()

# Получение последних 5 команд
recent = terminal.get_command_history(limit=5)
```

## Рекомендации по использованию

1. **Всегда включайте режим безопасности** в производственной среде
2. **Ограничивайте таймауты** для предотвращения долгого выполнения команд
3. **Проверяйте возвращаемые значения** - не полагайтесь только на success
4. **Используйте execute_python_script** для запуска Python-скриптов вместо прямого выполнения
5. **Добавляйте только необходимые директории** в список разрешенных

## Ограничения

1. Модуль не обеспечивает полной защиты от всех возможных атак
2. В режиме safe_mode=False отключаются проверки безопасности, что не рекомендуется
3. Некоторые команды могут работать по-разному в разных ОС
4. Модуль не защищает от атак, основанных на уязвимостях в ОС или внешних программах

## Тестирование

Для тестирования модуля используйте скрипт `tests/test_terminal_access.py`:

```bash
python tests/test_terminal_access.py
```

Возможные параметры тестирования:

- `--test basic` — тестирование базовых команд
- `--test unsafe` — тестирование отклонения опасных команд
- `--test directory` — тестирование навигации по директориям
- `--test timeout` — тестирование таймаутов команд
- `--test all` — запуск всех тестов (по умолчанию)
- `--safe-mode` — включение/выключение режима безопасности
