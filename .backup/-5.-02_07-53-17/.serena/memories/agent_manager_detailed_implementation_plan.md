# Подробный план реализации централизованного управления агентами

## 1. Улучшение AgentManager

**Цель:** Расширить существующий AgentManager для поддержки всех типов агентов и унифицированного взаимодействия с UI.

### Необходимые изменения:
1. **Добавить поддержку CodingAgent**
   - Обновить словарь AGENT_TYPES
   - Добавить методы для работы с CodingAgent

2. **Добавить механизм управления активными агентами**
   - Хранение и отслеживание всех активных агентов
   - Методы для получения активного агента для конкретного компонента UI

3. **Добавить шаблонные методы для создания специализированных агентов**
   - `create_coding_agent()`
   - `create_browser_agent()`

4. **Реализовать механизм кэширования агентов**
   - Возможность повторного использования агентов
   - Очистка неиспользуемых агентов

## 2. Создание унифицированного AgentWorker

**Цель:** Объединить существующие рабочие потоки в единый класс для обработки запросов к любому типу агента.

### Необходимые изменения:
1. **Переработать AgentWorker для поддержки всех типов агентов**
   - Поддержка различных типов сигналов в зависимости от типа агента
   - Унифицированный интерфейс запуска задач

2. **Реализовать фабрику AgentWorker**
   - Метод `create_worker_for_agent(agent)` в AgentManager
   - Автоматическое создание подходящего рабочего потока

3. **Добавить поддержку прямого и асинхронного выполнения**
   - Возможность выбора между синхронным и асинхронным выполнением
   - Обработка результатов в обоих режимах

## 3. Реализация AgentController

**Цель:** Создать промежуточный слой между UI и агентами для централизованного управления взаимодействием.

### Необходимые изменения:
1. **Создать класс AgentController**
   - Методы для отправки запросов агентам
   - Механизм маршрутизации ответов к соответствующим компонентам UI

2. **Реализовать систему сигналов**
   - Сигналы для обновления статуса агента
   - Сигналы для получения ответов от агента
   - Сигналы для обработки ошибок

3. **Реализовать подсистему контекста**
   - Сохранение контекста для каждого агента
   - Возможность передачи контекста между агентами
   - Синхронизация контекста с компонентами UI

## 4. Интеграция с компонентами UI

**Цель:** Модифицировать существующие компоненты UI для работы через AgentController.

### Необходимые изменения:
1. **Обновить CodingAgentDialog**
   - Использовать AgentController вместо прямого создания агента
   - Обновить обработку сигналов

2. **Обновить MainWindow**
   - Использовать AgentController для создания и управления основным агентом
   - Упростить логику подключения сигналов

3. **Доработать ChatWidget**
   - Добавить поддержку отправки запросов через AgentController
   - Обновить отображение ответов от агентов

4. **Обновить остальные компоненты UI**
   - Привести в соответствие с новым подходом
   - Унифицировать код взаимодействия с агентами

## 5. Реализация интерфейса IDE с интеграцией ИИ

**Цель:** Реализовать функции, указанные в workflow_state.md для интеграции чата с ИИ и редактора.

### Необходимые изменения:
1. **Добавить функции для передачи кода между чатом и редактором**
   - Вставка кода из чата в редактор
   - Отправка выделенного кода в чат
   - Анализ и исправление кода через ИИ

2. **Добавить элементы UI для взаимодействия с агентами**
   - Кнопки "Вставить в редактор" и "Запустить в терминале"
   - Пункты контекстного меню для взаимодействия с ИИ
   - Панель инструментов для быстрых действий

3. **Реализовать обработчики для новых элементов UI**
   - Обработка нажатий на кнопки
   - Обработка выбора пунктов контекстного меню
   - Передача выделенного кода агенту

## 6. Тестирование и отладка

**Цель:** Проверить корректность работы новой системы и устранить проблемы.

### Необходимые действия:
1. **Проверить корректность создания и получения агентов**
   - Правильное создание агентов разных типов
   - Правильное получение агентов по идентификатору

2. **Проверить работу AgentWorker**
   - Корректное выполнение запросов
   - Правильная передача результатов через сигналы

3. **Проверить взаимодействие UI с агентами**
   - Корректное отображение ответов от агентов
   - Правильная обработка ошибок

4. **Выявить и исправить проблемы с циклическими импортами**
   - Анализ зависимостей между модулями
   - Реорганизация кода для устранения циклических зависимостей

## 7. Документирование

**Цель:** Обновить документацию для отражения новой архитектуры.

### Необходимые действия:
1. **Добавить комментарии к новому и измененному коду**
   - Подробные описания классов и методов
   - Примеры использования

2. **Обновить существующую документацию**
   - Обновить описания компонентов
   - Отразить изменения в архитектуре

3. **Создать новую документацию по системе управления агентами**
   - Описание централизованного подхода
   - Руководство по использованию агентов в новых компонентах