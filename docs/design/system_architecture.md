# Архитектура системы GopiAI

## 1. Обзор системы

GopiAI — это интеллектуальная платформа для работы с LLM-моделями, обеспечивающая различные режимы взаимодействия пользователя с AI-агентами через графический интерфейс и API. Платформа построена по модульному принципу, где каждый компонент выполняет специализированную функцию и взаимодействует с другими компонентами через четко определенные интерфейсы.

## 2. Ключевые компоненты системы

### 2.1. Ядро системы (Core)

Ядро системы обеспечивает базовую функциональность и управление конфигурацией:

- **app/config.py**: Управление конфигурацией приложения, загрузка настроек из TOML-файлов.
- **app/llm.py**: Интерфейс для взаимодействия с LLM-моделями (OpenAI, Azure, Bedrock).
- **app/logger.py**: Подсистема логирования.
- **app/schema.py**: Определения типов данных и структур.
- **app/exceptions.py**: Определения исключений.

### 2.2. Агенты (Agents)

Модули в директории `app/agent/` обеспечивают различные типы интеллектуальных агентов:

- **BaseAgent (app/agent/base.py)**: Базовый класс для всех агентов.
- **BrowserAgent (app/agent/browser.py)**: Агент для работы с веб-браузером.
- **ReactAgent (app/agent/react.py)**: Агент, использующий ReAct подход (размышление + действие).
- **SWEAgent (app/agent/swe.py)**: Агент для работы с программным кодом.
- **ToolCallAgent (app/agent/toolcall.py)**: Агент, использующий инструменты LLM-модели.
- **MCPAgent (app/agent/mcp.py)**: Агент для работы с протоколом MCP.

Специализированные модули для расширения возможностей агентов:
- **Reasoning (app/agent/reasoning.py)**: Компонент для логического рассуждения.
- **Planning (app/agent/planning.py)**: Стратегическое планирование действий.
- **ResourceManager (app/agent/resource_manager.py)**: Управление ресурсами агента.
- **ExperienceManager (app/agent/experience_manager.py)**: Управление опытом агента.

### 2.3. Потоки выполнения (Flows)

Модули в директории `app/flow/` определяют различные сценарии выполнения задач:

- **BaseFlow (app/flow/base.py)**: Базовый класс для всех потоков выполнения.
- **FlowFactory (app/flow/flow_factory.py)**: Фабрика для создания потоков выполнения.
- **PlanningFlow (app/flow/planning.py)**: Поток выполнения на основе планирования.

### 2.4. Pocket Flow

Модули в директории `app/pocketflow/` предоставляют облегченную версию системы потоков:

- **Orchestrator (app/pocketflow/orchestrator.py)**: Оркестратор для управления потоками.
- **Adapters (app/pocketflow/adapters.py)**: Адаптеры для различных источников данных.
- **Core (app/pocketflow/core.py)**: Базовая функциональность Pocket Flow.

### 2.5. Инструменты (Tools)

Модули в директории `app/tool/` предоставляют инструменты, которые могут использовать агенты:

- **BaseTool (app/tool/base.py)**: Базовый класс для всех инструментов.
- **Инструменты для работы с кодом**: code_analyze_tool.py, code_run_tool.py, code_edit_tool.py
- **Инструменты для работы с браузером**: browser_screenshot_tool.py, browser_analyzer_tool.py, browser_control_tool.py
- **Терминальные инструменты**: terminal.py, bash.py
- **Инструменты для поиска**: web_search.py, search/
- **MCP инструменты**: mcp.py

### 2.6. Пользовательский интерфейс (UI)

Модули в директории `app/ui/` определяют графический интерфейс пользователя:

- **MainWindow (app/ui/main_window.py)**: Главное окно приложения.
- **ChatWidget (app/ui/chat_widget.py)**: Виджет для чата с агентом.
- **BrowserWidget (app/ui/browser_widget.py)**: Виджет для отображения веб-страниц.
- **CodeEditorWidget (app/ui/code_editor_widget.py)**: Редактор кода.
- **TerminalWidget (app/ui/terminal_widget.py)**: Эмулятор терминала.
- **ThemeManager (app/ui/theme_manager.py)**: Управление темами оформления.

### 2.7. Шаблоны промптов (Prompts)

Модули в директории `app/prompt/` содержат шаблоны промптов для различных агентов:

- **Reflection (app/prompt/reflection.py)**: Промпты для рефлексии.
- **Browser (app/prompt/browser.py)**: Промпты для работы с браузером.
- **Reasoning (app/prompt/reasoning.py)**: Промпты для логического рассуждения.
- **Planning (app/prompt/planning.py)**: Промпты для планирования.

### 2.8. MCP (Model Context Protocol)

Модули в директории `app/mcp/` обеспечивают работу с протоколом MCP:

- **Server (app/mcp/server.py)**: Сервер MCP.
- **Client (app/mcp/client.py)**: Клиент MCP.
- **SequentialThinking (app/mcp/sequential_thinking.py)**: Компонент для последовательного мышления.
- **SerenaIntegration (app/mcp/serena_integration.py)**: Интеграция с Serena.

### 2.9. Утилиты (Utils)

Модули в директории `app/utils/` содержат общие утилиты:

- **Common (app/utils/common.py)**: Общие утилитарные функции.
- **FileOperations (app/utils/file_operations.py)**: Операции с файлами и файловой системой.
- **ErrorHandling (app/utils/error_handling.py)**: Обработка ошибок и исключений.

## 3. Взаимодействие компонентов

### 3.1. Основная схема взаимодействия

```
+----------------+     +----------------+     +-----------------+
|   UI           |---->|  Agents        |---->|  Tools          |
|  (app/ui/)     |<----|  (app/agent/)  |<----|  (app/tool/)    |
+----------------+     +----------------+     +-----------------+
        |                      |                      |
        v                      v                      v
+----------------+     +----------------+     +-----------------+
|   Flows        |---->|  LLM           |---->|  Utils          |
|  (app/flow/)   |<----|  (app/llm.py)  |<----|  (app/utils/)   |
+----------------+     +----------------+     +-----------------+
        |                      |                      |
        v                      v                      v
+----------------+     +----------------+     +-----------------+
|  PocketFlow     |---->| Prompts        |---->|  MCP            |
| (app/pocketflow/)|<----| (app/prompt/)  |<----| (app/mcp/)     |
+----------------+     +----------------+     +-----------------+
```

### 3.2. Ключевые точки взаимодействия

1. **Пользовательский интерфейс <-> Агенты**:
   - UI предоставляет элементы управления для взаимодействия с агентами
   - Агенты возвращают результаты для отображения в UI

2. **Агенты <-> Инструменты**:
   - Агенты используют инструменты для выполнения конкретных действий
   - Инструменты возвращают результаты агентам для дальнейшей обработки

3. **Агенты <-> LLM**:
   - Агенты формируют запросы к LLM-моделям
   - LLM-модели возвращают ответы агентам

4. **Потоки <-> Агенты**:
   - Потоки управляют последовательностью действий агентов
   - Агенты выполняют задачи в контексте потока

5. **Промпты <-> Агенты**:
   - Агенты используют шаблоны промптов для формирования запросов
   - Промпты определяют поведение и возможности агентов

6. **MCP <-> Агенты**:
   - MCP предоставляет интерфейс для расширенной работы с контекстом
   - Агенты используют MCP для сложных задач мышления

## 4. Анализ текущей архитектуры

### 4.1. Сильные стороны

- **Модульность**: Система имеет четкое разделение на компоненты с определенной ответственностью.
- **Расширяемость**: Архитектура позволяет добавлять новые типы агентов, инструментов и потоков.
- **Разнообразие агентов**: Система поддерживает различные типы агентов для разных задач.
- **Интеграционные возможности**: Модули MCP и PocketFlow обеспечивают интеграцию с внешними системами.

### 4.2. Слабые стороны

- **Слабая связность компонентов**: Многие модули не связаны с основной логикой системы.
- **Дублирование функциональности**: Наблюдается дублирование кода в разных модулях.
- **Недостаточная стандартизация**: Отсутствие общих интерфейсов и соглашений между модулями.
- **Избыточность**: Большое количество файлов с похожей функциональностью.

## 5. Рекомендации по улучшению

### 5.1. Архитектурные улучшения

1. **Усиление связности**:
   - Определить четкие зависимости между компонентами
   - Внедрить инверсию зависимостей (Dependency Inversion)
   - Создать централизованный реестр компонентов

2. **Стандартизация интерфейсов**:
   - Разработать общие интерфейсы для агентов, инструментов и потоков
   - Внедрить абстрактные базовые классы для ключевых компонентов
   - Определить контракты взаимодействия между модулями

3. **Консолидация функциональности**:
   - Объединить похожие инструменты и агенты
   - Выделить базовые классы для повторяющейся функциональности
   - Использовать общие утилиты вместо дублирования кода

### 5.2. Технические улучшения

1. **Использование утилитарной инфраструктуры**:
   - Заменить дублирующийся код на использование модулей app/utils
   - Стандартизировать обработку ошибок с использованием app/utils/error_handling.py
   - Унифицировать работу с файлами через app/utils/file_operations.py

2. **Улучшение системы конфигурации**:
   - Централизовать настройки всех компонентов
   - Добавить валидацию конфигурации
   - Внедрить систему переопределения настроек для различных окружений

3. **Оптимизация обмена данными**:
   - Разработать стандартизированную шину событий
   - Внедрить паттерн "Наблюдатель" (Observer) для уведомлений между компонентами
   - Унифицировать форматы данных между компонентами

## 6. Заключение

Архитектура системы GopiAI представляет собой модульную систему с широкими возможностями, но требует улучшения связности и стандартизации компонентов. Реализация предложенных рекомендаций позволит улучшить поддерживаемость, расширяемость и надежность системы, а также упростит интеграцию новых функций в будущем.
