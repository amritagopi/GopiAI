#!/usr/bin/env python3
"""
Response Refinement Crew –¥–ª—è GopiAI

–†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω researcher ‚Üí analyst ‚Üí editor —Å –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
–¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è —Å—ã—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤ –≤ —Ü–µ–ª—å–Ω—ã–µ, —á–∏—Ç–∞–µ–º—ã–µ –æ—Ç–≤–µ—Ç—ã.
"""
import signal

from crewai import Agent, Task, Crew, Process


class RefinementCrew:
    """
    Crew –¥–ª—è –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —Å—Ö–µ–º–µ:
    researcher ‚Üí analyst ‚Üí editor ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ DONE ‚Üí –ø–æ–≤—Ç–æ—Ä –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    """
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –¥–ª—è —Ä–µ—Ñ–∏–Ω–µ–º–µ–Ω—Ç–∞"""
        self.max_iterations = 3
        self.current_iteration = 0
        
    def researcher(self) -> Agent:
        """–ê–≥–µ–Ω—Ç-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å: —Å–æ–±–∏—Ä–∞–µ—Ç —Ñ–∞–∫—Ç—ã, –¥–∞–Ω–Ω—ã–µ, —Å—Å—ã–ª–∫–∏"""
        return Agent(
            role="Researcher",
            goal="–ù–∞–π—Ç–∏ –∏ —Å–æ–±—Ä–∞—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏–º–µ—Ä—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {query}",
            backstory=(
                "–û–ø—ã—Ç–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å —Ç–æ—á–Ω—É—é –∏ –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. "
                "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —Ñ–∞–∫—Ç–æ–≤ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏. "
                "–ò–∑–±–µ–≥–∞–µ—Ç –¥–æ–º—ã—Å–ª–æ–≤ - —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π."
            ),
            verbose=True,
            allow_delegation=False,
            max_iter=2,
        )

    def analyst(self) -> Agent:
        """–ê–≥–µ–Ω—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è"""
        return Agent(
            role="Analyst", 
            goal="–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è, –≤—ã—è–≤–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏",
            backstory=(
                "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º—ã—Å–ª—è—â–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. "
                "–í—ã–¥–µ–ª—è–µ—Ç –≥–ª–∞–≤–Ω–æ–µ, –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ñ–∞–∫—Ç–∞–º–∏, —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ. "
                "–§–æ—Ä–º–∏—Ä—É–µ—Ç –ª–æ–≥–∏—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞."
            ),
            verbose=True,
            allow_delegation=False,
            max_iter=2,
        )

    def editor(self) -> Agent:
        """–ê–≥–µ–Ω—Ç-—Ä–µ–¥–∞–∫—Ç–æ—Ä: –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —á–∏—Ç–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç"""
        return Agent(
            role="Editor",
            goal=(
                "–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å–Ω—ã–π, —è—Å–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–±–æ—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞. "
                "–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–ª–æ–≤–æ–º 'READY'"
            ),
            backstory=(
                "–û–ø—ã—Ç–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç. "
                "–£–±–∏—Ä–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä—ã, –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —Å—Ç–∏–ª—å –ø–æ–¥ –∞—É–¥–∏—Ç–æ—Ä–∏—é. "
                "–†–µ—à–∞–µ—Ç - –≥–æ—Ç–æ–≤ –ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –∏–ª–∏ –Ω—É–∂–Ω–∞ –µ—â–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∞."
            ),
            verbose=True,
            allow_delegation=False,
            max_iter=3,
        )

    def research_task(self) -> Task:
        """–ó–∞–¥–∞—á–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: —Å–±–æ—Ä —Ñ–∞–∫—Ç–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö"""
        return Task(
            description=(
                "–ò—Å—Å–ª–µ–¥—É–π —Ç–µ–º—É: {query}\n"
                "–í–ê–ñ–ù–û: –î–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥—ã 'ls -la', 'ls -1', 'file' –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.\n"
                "–ù–ï —á–∏—Ç–∞–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.\n"
                "–ó–∞–¥–∞—á–∞:\n"
                "1. –î–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º: –ø–æ–ª—É—á–∏ —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –∏ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤\n"
                "2. –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ–º: –Ω–∞–π–¥–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è\n"
                "3. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –Ω–∞—Ö–æ–¥–∫–∏ —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏\n"
                "4. –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ - –æ–ø–∏—à–∏ –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º\n\n"
                "–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}\n"
                "–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏: —Ä–∞–±–æ—Ç–∞–π –±—ã—Å—Ç—Ä–æ, –Ω–µ —É–≥–ª—É–±–ª—è–π—Å—è –≤ –¥–µ—Ç–∞–ª–∏!"
            ),
            agent=self.researcher(),
            expected_output="–ö—Ä–∞—Ç–∫–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–º–µ"
        )

    def analysis_task(self) -> Task:
        """–ó–∞–¥–∞—á–∞ –∞–Ω–∞–ª–∏–∑–∞: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è"""
        return Task(
            description=(
                "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ —Ç–µ–º–µ: {query}\n"
                "–ù–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è:\n"
                "1. –í—ã–¥–µ–ª–∏ 3-5 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–∑–∏—Å–æ–≤\n"
                "2. –ù–∞–π–¥–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ñ–∞–∫—Ç–∞–º–∏\n"
                "3. –û–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–æ–±–µ–ª—ã –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
                "4. –ü—Ä–µ–¥–ª–æ–∂–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞\n"
                "5. –£–∫–∞–∂–∏, –∫–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\n"
                "–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}"
            ),
            agent=self.analyst(),
            expected_output="–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å–∫–∞ —Å —Ç–µ–∑–∏—Å–∞–º–∏, –≤—ã–≤–æ–¥–∞–º–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞"
        )

    def editing_task(self) -> Task:
        """–ó–∞–¥–∞—á–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"""
        return Task(
            description=(
                "–°–æ–∑–¥–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ —Ç–µ–º—É: {query}\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π:\n"
                "- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è\n"
                "- –ê–Ω–∞–ª–∏–∑ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∞\n"
                "- –ü—Ä–µ–¥—ã–¥—É—â–∏–π —á–µ—Ä–Ω–æ–≤–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å): {previous_draft}\n\n"
                "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n"
                "1. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —è—Å–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n"
                "2. –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å—Ç–∏–ª—å –ø–æ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞: {context}\n"
                "3. –£–±–µ—Ä–∏ –ø–æ–≤—Ç–æ—Ä—ã, –∏—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏\n"
                "4. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤ - –∑–∞–≤–µ—Ä—à–∏ —Å–ª–æ–≤–æ–º 'READY'\n"
                "5. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ - –æ–±—ä—è—Å–Ω–∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ\n\n"
                "–ò—Ç–µ—Ä–∞—Ü–∏—è: {iteration} –∏–∑ {max_iterations}"
            ),
            agent=self.editor(),
            expected_output="–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ –¥–æ—Ä–∞–±–æ—Ç–∫–µ"
        )

    def crew(self) -> Crew:
        """–°–æ–∑–¥–∞–Ω–∏–µ crew —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º"""
        return Crew(
            agents=[self.researcher(), self.analyst(), self.editor()],
            tasks=[self.research_task(), self.analysis_task(), self.editing_task()],
            process=Process.sequential,
            planning=True,  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω
            verbose=True
        )


def iterative_refinement(
    query: str, 
    context: str = "", 
    max_rounds: int = 2,
    timeout_per_iteration: int = 60
) -> tuple[str, list[str]]:
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ—Ñ–∏–Ω–µ–º–µ–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
    
    Args:
        query: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        max_rounds: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
        timeout_per_iteration: –¢–∞–π–º–∞—É—Ç –Ω–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
    Returns:
        Tuple[—Ñ–∏–Ω–∞–ª—å–Ω—ã–π_–æ—Ç–≤–µ—Ç, –∏—Å—Ç–æ—Ä–∏—è_–∏—Ç–µ—Ä–∞—Ü–∏–π]
    """
    refinement_crew = RefinementCrew()
    crew_instance = refinement_crew.crew()
    
    previous_draft = ""
    history = []
    
    for iteration in range(1, max_rounds + 1):
        print(f"\nüîÑ –ò—Ç–µ—Ä–∞—Ü–∏—è {iteration}/{max_rounds}")
        
        inputs = {
            "query": query,
            "context": context,
            "previous_draft": previous_draft,
            "iteration": iteration,
            "max_iterations": max_rounds
        }
        
        try:
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
            def timeout_handler(signum, frame):
                raise TimeoutError(f"Iteration {iteration} exceeded {timeout_per_iteration} seconds")
            
            signal.signal(signal.SIGALRM, timeout_handler)
            signal.alarm(timeout_per_iteration)
            
            result = crew_instance.kickoff(inputs=inputs)
            
            # –°–Ω–∏–º–∞–µ–º —Ç–∞–π–º–∞—É—Ç
            signal.alarm(0)
            
            output = str(result.raw) if hasattr(result, 'raw') else str(result)
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –≤—ã–≤–æ–¥–∞
            if len(output) > 2000:
                output = output[:2000] + "... [–æ—Ç–≤–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω]"
            
            history.append(f"[Iteration {iteration}]\n{output}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
            if "READY" in output.upper():
                print(f"‚úÖ –û—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ {iteration} –∏—Ç–µ—Ä–∞—Ü–∏–π")
                # –£–±–∏—Ä–∞–µ–º READY –∏–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                final_output = output.replace("READY", "").replace("ready", "").strip()
                return final_output, history
                
            previous_draft = output
            print(f"‚è≥ –ò—Ç–µ—Ä–∞—Ü–∏—è {iteration} –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...")
            
        except (Exception, TimeoutError) as e:
            # –°–Ω–∏–º–∞–µ–º —Ç–∞–π–º–∞—É—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            signal.alarm(0)
            
            error_msg = f"‚ùå –û—à–∏–±–∫–∞ –≤ –∏—Ç–µ—Ä–∞—Ü–∏–∏ {iteration}: {str(e)}"
            print(error_msg)
            history.append(error_msg)
            
            if iteration == 1:
                # –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
                return f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å: {str(e)}", history
            else:
                # –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–±–æ—á–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                return previous_draft, history
    
    print(f"‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π ({max_rounds})")
    return previous_draft, history


if __name__ == "__main__":
    # –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —Ä–µ—Ñ–∏–Ω–µ–º–µ–Ω—Ç–∞
    test_query = "–ß—Ç–æ –≤ –ø–∞–ø–∫–µ /home/amritagopi/go –∏ –æ–ø–∏—à–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ"
    test_context = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ–Ω—è—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–≤–æ–µ–π —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ä–µ—Ñ–∏–Ω–µ–º–µ–Ω—Ç–∞...")
    final_answer, iterations = iterative_refinement(
        query=test_query,
        context=test_context,
        max_rounds=2
    )
    
    print(f"\nüìã –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢:\n{final_answer}")
    print(f"\nüìä –ò—Å—Ç–æ—Ä–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–π: {len(iterations)} —à–∞–≥–æ–≤")