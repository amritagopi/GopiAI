# Workflow State

## TODO

- [x] Реализовать функцию анализа зависимостей проекта.
- [x] Реализовать функцию поиска неиспользуемого кода.
- [x] Реализовать функцию генерации отчёта о дублировании кода.
- [x] Реализовать функцию маркировки неиспользуемого (мёртвого) кода.
- [x] Интегрировать разработанные функции в интерфейс IDE.

## Журнал

- **Реализована функция анализа зависимостей проекта:** Создан файл `analyze_dependencies.py`, реализующая функцию анализа зависимостей проекта с использованием библиотеки `ast`. Функция обходит все `.py` файлы в проекте, анализирует AST-дерево и извлекает имена импортируемых модулей. Добавлены логирование и пример использования.  **Исправлена ошибка:** Добавлена обработка исключений `SyntaxError` и `UnicodeDecodeError` для пропуска файлов с ошибками.

- **Реализована функция поиска неиспользуемого кода:** Создан файл `find_unused_files.py`, реализующий функцию поиска неиспользуемых файлов в проекте. Функция использует результаты анализа зависимостей для определения файлов, которые не импортируются другими модулями. Реализован механизм преобразования имен модулей в пути к файлам. Добавлено автоматическое создание отчетов в директории `imports_reports` с информацией о неиспользуемых файлах. Реализовано логирование процесса анализа.

- **Реализована функция генерации отчёта о дублировании кода:** Создан файл `duplicate_code_report.py`, реализующий расширенную функциональность для анализа и визуализации дублирующегося кода в проекте. Модуль использует базовый анализатор `find_duplicate_code.py` и добавляет возможности по генерации различных форматов отчетов (HTML, JSON, TXT), а также визуальных представлений результатов анализа с помощью matplotlib. Реализованы функции создания круговых диаграмм, гистограмм и тепловых карт для наглядного представления найденных дубликатов. Добавлена возможность фильтрации результатов и гибкая настройка параметров анализа через аргументы командной строки.

- **Реализована функция маркировки неиспользуемого (мёртвого) кода:** Создан улучшенный файл `improve_mark_dead_code.py`, расширяющий базовую функциональность `mark_dead_code.py`. Реализованы следующие улучшения: детальная интерактивная визуализация с графиками и диаграммами, система оценки "мертвости" кода на основе уровня доверия, возможность отмены внесенных изменений (undo), интеграция с системой контроля версий, создание резервных копий файлов перед модификацией, оценка влияния удаления кода на систему, а также гибкие настройки через параметры командной строки (включая интерактивный режим, режим без внесения изменений и другие). Добавлена функция ведения подробного журнала всех выполненных действий и формирование отчётов в различных форматах.

- **Анализ существующего интерфейса:** Проведен анализ компонентов графического интерфейса приложения. Обнаружено, что основные компоненты IDE уже реализованы: главное окно (`MainWindow`), редактор кода (`CodeEditor`), терминал (`TerminalWidget`), проводник проекта (`ProjectExplorer`), чат с ИИ (`ChatWidget`), панель инструментов (`ToolsWidget`) и другие. Интерфейс поддерживает локализацию, тематическое оформление и плагины. Для интеграции разработанных инструментов анализа кода требуется добавить специализированную вкладку в виджет инструментов или создать отдельный виджет для этих функций.

- **Интеграция функций анализа кода в интерфейс IDE:** Создан адаптер `code_analysis_integration_adapter.py` для соединения разработанных функций анализа кода с графическим интерфейсом. Разработан унифицированный интерфейс для всех аналитических инструментов, обеспечивающий согласованное взаимодействие пользователя. Доработан виджет анализа кода (`code_analysis_widget.py`) для использования адаптера и предоставления пользователю доступа ко всем функциям анализа через удобный графический интерфейс. Реализована асинхронная обработка результатов анализа с использованием отдельных потоков, индикация прогресса, подробное логирование выполнения и просмотр результатов в различных форматах. Интеграция позволяет запускать все функции анализа непосредственно из IDE, настраивать параметры анализа через графический интерфейс и просматривать результаты в интерактивном режиме.

## План интеграции виджетов в интерфейс с плавающими окнами

### 1. Архитектура интерфейса с плавающими окнами

#### 1.1. Основные компоненты архитектуры
- **Главное окно (MainWindow)**: Базовый контейнер с системой док-виджетов
- **Док-менеджер**: Система управления плавающими/пристыкованными виджетами
- **Менеджер вкладок (TabManager)**: Управление вкладками внутри доков
- **Менеджер состояний (StateManager)**: Сохранение/восстановление расположения окон
- **Менеджер тем (ThemeManager)**: Унифицированное оформление всех компонентов

#### 1.2. Структура доков
- **Центральная область**: Основное рабочее пространство (редактор кода/браузер/другие инструменты)
- **Левая область (по умолчанию)**: Проводник проекта, список символов и другие инструменты навигации
- **Правая область (по умолчанию)**: Чат с агентом, инструменты анализа, настройки
- **Нижняя область (по умолчанию)**: Терминал, вывод, консоль, журналы
- **Плавающие окна**: Любой компонент может быть отсоединен и становиться плавающим

#### 1.3. Механизмы управления окнами
- **Перетаскивание**: Возможность перетаскивать любой виджет между доками
- **Переключение режимов**: Плавающее окно ↔ Вкладка ↔ Закрепленная панель
- **Автоскрытие**: Возможность автоматически скрывать панель, но оставлять язычок доступа
- **Контекстные меню**: Меню для управления режимами виджетов
- **Горячие клавиши**: Быстрый доступ к часто используемым функциям и переключению между виджетами

### 2. Интеграция основных компонентов

#### 2.1. Редактор кода (`code_editor_widget.py`, `code_editor.py`)
- **Функциональность**:
  - Редактирование кода с подсветкой синтаксиса (`syntax_highlighter.py`)
  - Автодополнение кода
  - Навигация по коду (переход к определению, найти использования)
  - Поддержка множества вкладок для разных файлов
  - Встроенная мини-карта кода
  - Линтеры и индикаторы ошибок
  - Инлайн-подсказки от ИИ
  - История изменений и локальный откат
- **Интеграция с плавающими окнами**:
  - Редактор может открываться как в центральной области, так и в отдельном окне
  - Вкладки редактора могут отсоединяться в отдельные окна
  - Возможность разделения области редактора для параллельного просмотра нескольких файлов
  - Интеграция с окном ИИ-агента для получения рекомендаций по коду

#### 2.2. Файловый проводник (`project_explorer.py`)
- **Функциональность**:
  - Древовидная структура проекта
  - Фильтрация по типам файлов
  - Контекстные меню для файловых операций
  - Поиск по файлам
  - Отображение статуса файлов (git-статус, результаты анализа и т.д.)
  - Drag-and-drop для перемещения файлов
- **Интеграция с плавающими окнами**:
  - По умолчанию закреплен слева, но может быть отсоединен или закрыт
  - Возможность открытия нескольких проводников для разных директорий проекта
  - Интеграция с другими инструментами через drag-and-drop

#### 2.3. Чат с ИИ агентом (`chat_widget.py`, `reasoning_agent_dialog.py`)
- **Функциональность**:
  - Чат-интерфейс для общения с ИИ
  - История сообщений и контекста
  - Кнопки быстрых действий и подсказок
  - Поддержка отправки контекста (выделенный код, файлы и т.д.)
  - Возможность сохранять и загружать чаты
  - Выбор моделей и настройка параметров генерации
  - Возможность использования эмодзи (`emoji_dialog.py`)
- **Интеграция с плавающими окнами**:
  - По умолчанию закреплен справа, но может быть отсоединен или закрыт
  - Возможность открытия нескольких чатов с разными агентами
  - Интеграция с редактором кода через контекстные меню

#### 2.4. Терминал (`terminal_widget.py`)
- **Функциональность**:
  - Эмуляция терминала с полной поддержкой ANSI
  - Многостраничный интерфейс для нескольких сессий
  - История команд и автодополнение
  - Контекстное меню с копированием/вставкой/поиском
  - Интеграция с системой сборки и запуска проекта
- **Интеграция с плавающими окнами**:
  - По умолчанию закреплен снизу, но может быть отсоединен или закрыт
  - Возможность открытия нескольких терминалов
  - Split-view для параллельной работы с несколькими терминалами

#### 2.5. Браузер (`browser_widget.py`, `browser_tab_widget.py`, `browser_agent_interface.py`)
- **Функциональность**:
  - Полноценный веб-браузер на основе WebEngine
  - Поддержка вкладок
  - Адресная строка с поиском
  - История и закладки
  - Интеграция с ИИ для анализа содержимого страниц
  - Инструменты разработчика
- **Интеграция с плавающими окнами**:
  - Может работать как вкладка в центральной области или как отдельное окно
  - Отдельные вкладки могут быть отсоединены в плавающие окна
  - Возможность интеграции с отдельным агентом для работы в интернете (`browser_agent_dialog.py`)

### 3. Интеграция аналитических инструментов

#### 3.1. Анализатор кода (`code_analysis_widget.py`, `code_analysis_integration.py`)
- **Функциональность**:
  - Интеграция всех разработанных инструментов анализа:
    - Анализ зависимостей (visualize_dependencies.py)
    - Поиск неиспользуемого кода (find_unused_files.py)
    - Анализ дублирования кода (duplicate_code_report.py)
    - Маркировка мертвого кода (improve_mark_dead_code.py)
  - Интерактивные графики и визуализации
  - Фильтры и настройки анализа
  - Возможность применения изменений напрямую в код
- **Интеграция с плавающими окнами**:
  - Может быть вкладкой справа или плавающим окном
  - Интегрируется с редактором кода через подсветку проблемных участков
  - Может запускаться как по требованию, так и в фоновом режиме

#### 3.2. Визуализатор потоков (`flow_visualizer.py`)
- **Функциональность**:
  - Визуализация PocketFlow потоков
  - Редактирование потоков через графический интерфейс
  - Отладка потоков с пошаговым выполнением
  - Статистика и метрики выполнения
- **Интеграция с плавающими окнами**:
  - Может быть отдельной вкладкой в центральной области или плавающим окном
  - Интеграция с редактором кода для переходов между визуальным представлением и кодом

#### 3.3. Виджет рассуждений ИИ (`thought_tree_widget.py`)
- **Функциональность**:
  - Отображение дерева мыслей/рассуждений ИИ агента
  - Возможность расширять/сворачивать ветви рассуждений
  - Показ уверенности в решениях
  - Интерактивное взаимодействие с деревом рассуждений
- **Интеграция с плавающими окнами**:
  - Может быть вкладкой в правой панели или отдельным плавающим окном
  - Синхронизируется с действиями чат-агента

### 4. Вспомогательные компоненты и управление

#### 4.1. Менеджер меню (`menu_manager.py`)
- Динамическое формирование меню в зависимости от контекста
- Поддержка горячих клавиш
- Интеграция с расширениями и плагинами
- Контекстные меню для всех компонентов

#### 4.2. Управление темами (`theme_manager.py`, `theme_settings_dialog.py`)
- Переключение между светлой и тёмной темами
- Кастомизация цветовых схем
- Согласованность тем между всеми компонентами
- Сохранение пользовательских настроек

#### 4.3. Система локализации (`i18n/translator.py`)
- Поддержка нескольких языков интерфейса
- Переключение языка без перезапуска
- Автоматическое определение языка системы

#### 4.4. Менеджер сессий (`session_history_manager.py`)
- Сохранение состояния сессии (открытые файлы, расположение окон)
- История сессий и возможность восстановления
- Синхронизация между устройствами

#### 4.5. Настройки и предпочтения (`preferences_dialog.py`, `settings_widget.py`)
- Централизованная система настроек
- Категории настроек для различных компонентов
- Импорт/экспорт настроек
- Восстановление настроек по умолчанию

### 5. Расширение интерфейса ИИ агентов

#### 5.1. Интеграция ИИ с интерфейсом (`agent_ui_integration.py`)
- Бесшовная интеграция между компонентами UI и ИИ агентами
- API для обмена данными между UI и агентами
- Система уведомлений о действиях агентов
- Отображение состояния агентов (думает, генерирует, ожидает и т.д.)

#### 5.2. Агент для работы с кодом (`coding_agent_interface.py`)
- Специализированный интерфейс для агента по работе с кодом
- Функции рефакторинга, описания кода, генерации документации
- Интеграция с анализаторами кода
- Подсветка изменений, предлагаемых агентом

#### 5.3. Браузерный агент (`browser_agent_interface.py`)
- Специализированный интерфейс для агента по работе с веб-контентом
- Анализ веб-страниц, поиск информации, генерация отчетов
- Интеграция с браузерным движком
- Возможность автоматизации веб-задач

#### 5.4. Планирование и планы (`plan_view_widget.py`)
- Отображение планов решения задач
- Отслеживание прогресса выполнения
- Возможность редактирования плана пользователем
- Интеграция с чат-агентом и редактором кода

### 6. Взаимодействие компонентов и сценарии использования

#### 6.1. Плавная интеграция редактора и агентов
- Возможность выделить код и отправить в чат с агентом
- Возможность применить предложенные агентом изменения непосредственно в редакторе
- Визуализация изменений, предлагаемых агентом, перед их применением
- Подсветка проблемных мест в коде на основе анализа агента
- Совместное редактирование кода с агентом

#### 6.2. Сценарии работы с плавающими окнами
- Возможность работать с несколькими агентами одновременно в разных окнах
- Настраиваемые рабочие пространства для разных задач (разработка, отладка, аналитика)
- Полноэкранный режим для отдельных компонентов
- Запоминание и восстановление различных конфигураций расположения окон
- Предустановленные наборы конфигураций для разных сценариев использования

#### 6.3. Многооконное управление IDE
- Возможность открыть несколько окон IDE для работы с разными проектами
- Синхронизация настроек между окнами
- Передача контекста между окнами через drag-and-drop
- Специализированные окна для разных типов файлов (код, конфигурации, данные)

### 7. Технические особенности реализации

#### 7.1. Использование DockTitleBar (`dock_title_bar.py`)
- Кастомный заголовок для доков с кнопками управления (закрыть, свернуть, отсоединить)
- Индикаторы состояния компонента
- Контекстное меню для управления доком

#### 7.2. Системы исправления интерфейса
- Исправление закрытия вкладок (`close_button_fixer.py`, `fix_tabs.py`)
- Обработка стилей для согласованности (`styles.py`)
- Управление иконками (`icon_manager.py`)

#### 7.3. Оптимизация производительности
- Ленивая загрузка компонентов
- Кэширование данных для быстрого доступа
- Асинхронное выполнение тяжелых операций
- Эффективное использование памяти и CPU

### 8. Поэтапный план реализации

#### 8.1. Фаза 1: Базовая структура плавающих окон
- Реализация базовой инфраструктуры доков и вкладок
- Настройка перетаскивания и изменения размеров
- Создание механизма сохранения/восстановления состояния расположения

#### 8.2. Фаза 2: Интеграция основных виджетов
- Адаптация существующих виджетов для работы в системе плавающих окон
- Настройка взаимодействия между компонентами
- Реализация контекстных меню и горячих клавиш

#### 8.3. Фаза 3: Расширенные возможности и оптимизация
- Добавление продвинутых функций (автоскрытие, пользовательские настройки)
- Оптимизация производительности
- Улучшение UX/UI и согласованности интерфейса

#### 8.4. Фаза 4: Интеграция аналитических инструментов
- Встраивание разработанных инструментов анализа кода
- Создание единого интерфейса для всех инструментов
- Настройка визуализации результатов анализа

### 9. Приоритеты компонентов

1. **Высокий приоритет**:
   - Основная система плавающих окон
   - Редактор кода и его интеграция с агентами
   - Чат с ИИ агентом
   - Файловый проводник

2. **Средний приоритет**:
   - Терминал
   - Браузер
   - Инструменты анализа кода
   - Визуализатор потоков

3. **Низкий приоритет**:
   - Дополнительные настройки тем
   - Расширенная локализация
   - Специализированные виджеты для отдельных типов файлов
